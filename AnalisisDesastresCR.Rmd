---
title: "Visualización de la base de datos de desastres en Costa Rica"
author: "Guillermo Durán Sanabria"
date: "11/16/2018"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

El objetivo de este tutorial es hacer un análisis temporal y geográfico de los desastres relacionados a eventos hidrometeorológicos y deslizamientos en Costa Rica. El análisis se llevará a cabo utilizando datos publicos generados por distintas instituciones gubernamentales de Costa Rica.  

### Procedencia de los datos
Los datos se extrayeron del pdf de la 2nda edición del documento *Histórico de desastres en Costa Rica. Febrero 1723 - Abril 2017* elaborado por la **Comisión nacional de prevención de riesgos y atención de emergencias (CNE) de Costa Rica** utilizando la herramienta gratuita Tabula https://tabula.technology

El documento pdf puede ser descargado en el siguiente enlace:
https://www.cne.go.cr/index.php/documentacienuprincipal-96/historico-de-desastres-en-costa-rica

Para el análisis se extrayeron del documento las tablas sobre los eventos hidrometeorológicos y deslizamientos. Se seleccionaron únicamente estos dos tipos de desastres por ser los que guardan una relación directa a variabilidad y cambio climático.

Este tutorial se llevará a cabo utilizando R junto con los paquetes del **tidyverse** para la manipulación de los datos y análisis de texto, **lubridate** para las series de tiempo, y los paquetes **sf** y **tmap** para el análisis espacial y generación de mapas.
```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(lubridate)
library(sf)
library(tmap)
```



1. Preparación de la tabla general, utilizando las tablas generadas en Tabula (notese que la columna de FECHA se está importando como tipo *date* y se están eliminando los encabezados de cada tabla individual)
```{r message=FALSE, warning=FALSE}
tablahidro <- read_csv("datos/tabula-historico_desastres_hidrometeo.csv", 
    col_types = cols(FECHA = col_date(format = "%Y/%m/%d"))) %>% 
  na.omit() %>% 
  mutate(TIPO = "Hidrometeorológicos")

tablades <- read_csv("datos/tabula-historico_desastres_deslizamientos.csv", 
    col_types = cols(FECHA = col_date(format = "%Y/%m/%d"))) %>% 
  na.omit() %>% 
  mutate(TIPO = "Deslizamientos")

names(tablahidro) <- names(tablades) #hacemos que los encabezados de ambas tablas sean iguales 
tablaGeneral <- rbind(tablades, tablahidro) %>%  #juntamos ambas tablas en una tabla general
  mutate(ID = row_number())
```

Cronología con el número de eventos por cada tipo (Hidrometeorológicos y Deslizamientos) por año.
```{r}
ggplot(tablaGeneral %>% 
         mutate(aNo = year(FECHA)) %>% 
         group_by(aNo, TIPO) %>% 
         summarise(Cantidad = n()), 
       aes(x = aNo, y = Cantidad)) +
  geom_col() +
  facet_grid(rows = vars(TIPO)) +
  labs(x = "Año")
```

2. Asignación geográfica a los eventos.

Dado que la tabla no tiene un componente geográfico en su estructura, vamos a asignarle uno utilizando el siguiente código. Este crea una columna lógica por provincia y le asigna un **T** o **F** si el nombre de la provincia aparece en la columna *`TÍTULO DEL EVENTO`*. Se hizo de esta manera ya que hay varios eventos que reportaron daños en varias provincias.

```{r}
tablaGeneral_mod <- tablaGeneral %>% 
  mutate(
    `TÍTULO DEL EVENTO` = str_replace_all(`TÍTULO DEL EVENTO`, "\\r", " "),
    OBSERVACIONES  = str_replace_all(`TÍTULO DEL EVENTO`, "\\r", " "),
    Desc = paste(`TÍTULO DEL EVENTO`, OBSERVACIONES, sep = " "),
    GUANACASTE = if_else(str_detect(Desc, "Guanacaste"), TRUE, FALSE),
    SANJOSE = if_else(str_detect(Desc, "San José"), TRUE, FALSE),
    HEREDIA = if_else(str_detect(Desc, "Heredia"), TRUE, FALSE),
    ALAJUELA = if_else(str_detect(Desc, "Alajuela"), TRUE, FALSE),
    PUNTARENAS = if_else(str_detect(Desc, "Puntarenas"), TRUE, FALSE),
    CARTAGO = if_else(str_detect(Desc, "Cartago"), TRUE, FALSE),
    LIMON = if_else(str_detect(Desc, "Limón"), TRUE, FALSE))
```

El conteo de eventos por provincia es:
```{r}
tablaGeneral_mod %>% select(8:14) %>% summarise_all(funs(sum(.)))
```

Revisión de elementos sin provincia asignada:
```{r}
faltantes <- tablaGeneral_mod %>% 
  mutate(total = GUANACASTE + SANJOSE + HEREDIA + ALAJUELA + PUNTARENAS + CARTAGO + LIMON) %>% 
  filter(total == 0)

faltantes %>% summarise(n())
```

Deberemos asignar provincia a los 49 eventos que quedaron sin asignar. 

Como el número de entradas que quedaron sin asignar no es tan grande, la asignación de las provincias podría hacerse fácilmente en un programa de hoja de cálculo (Excel, por ejemplo), pero también lo podemos hacer desde R.

Sería interesante hacer un conteo de las palabras más comunes en los títulos de esos 49 eventos en que no se les asignó provincia, para esto vamos a necesitar el paquete tidytext y un vector de *stop_words* en Castellano.

```{r}
library(tm)
library(tidytext)

custom_stop_words <- bind_rows(
  stop_words,
  data_frame(Palabras = tm::stopwords(kind = "sp"),
             lexicon = "custom")) %>% 
  filter(lexicon == "custom")
```


```{r}
faltantes %>% select(ID, Desc) %>%
  unnest_tokens(Palabras, Desc) %>% 
  anti_join(custom_stop_words) %>%
  count(Palabras, sort = TRUE)
```

Viendo las palabras más comunes es posible darnos cuenta que hay frases que debemos de asignar a provincias, estas son:
**Vertiente Caribe: Limón, Alajuela, Heredia, Cartago**
**Vertiente Caribe = Zona Atlántica**
**Zona Norte: Alajuela y Heredia**
**Valle Central: Heredia, San José, Alajuela y Cartago**
**Zona Sur: Puntarenas**

Escribimos un script que asocie esas palabras las asocie a las provincias respectivas:
```{r}
faltantes_mod <- faltantes %>% 
  mutate_at(.vars = c("LIMON", "ALAJUELA", "HEREDIA", "CARTAGO"), 
            funs(if_else(str_detect(Desc, regex("Vertiente Caribe", ignore_case = TRUE)), 
                         TRUE, .))) %>% 
  mutate_at(.vars = c("LIMON", "ALAJUELA", "HEREDIA", "CARTAGO"), 
            funs(if_else(str_detect(Desc, regex("Vertiente\\s*\\w*\\sCaribe", ignore_case = TRUE)), 
                         TRUE, .))) %>% 
  mutate_at(.vars = c("LIMON", "ALAJUELA", "HEREDIA", "CARTAGO"), 
            funs(if_else(str_detect(Desc, regex("Zona Caribe", ignore_case = TRUE)), 
                         TRUE, .))) %>% 
  mutate_at(.vars = c("LIMON", "ALAJUELA", "HEREDIA", "CARTAGO"), 
            funs(if_else(str_detect(Desc, regex("Zona Atlántica", ignore_case = TRUE)), 
                         TRUE, .))) %>% 
  mutate_at(.vars = c("ALAJUELA", "HEREDIA", "CARTAGO"), 
            funs(if_else(str_detect(Desc, regex("Zona Norte", ignore_case = TRUE)), 
                         TRUE, .))) %>% 
  mutate_at(.vars = c("PUNTARENAS"), 
            funs(if_else(str_detect(Desc, regex("Zona Sur", ignore_case = TRUE)), 
                         TRUE, .))) %>% 
  mutate_at(.vars = c("SANJOSE", "ALAJUELA", "HEREDIA", "CARTAGO"), 
            funs(if_else(str_detect(Desc, regex("Valle Central", ignore_case = TRUE)), 
                         TRUE, .)))
```
Faltantes:
```{r}
faltantes2 <- faltantes_mod %>% 
  mutate(total = GUANACASTE + SANJOSE + HEREDIA + ALAJUELA + PUNTARENAS + CARTAGO + LIMON) %>% 
  filter(total == 0)

faltantes2 %>% summarise(n())
```

```{r}
faltantes2
```

Revisando las descripciones de los últimos que quedan por asignar vemos que muchos son huracanes, tormentas (tropicales) y sistemas de baja (presión):
```{r}
faltantes2 %>% select(ID, Desc) %>%
  unnest_tokens(Palabras, Desc) %>% 
  anti_join(custom_stop_words) %>%
  count(Palabras, sort = TRUE)
```

Ya que estos no tienen una ubicación asignada, asumimos que afectaron a todo el país:
```{r}
faltantes2_mod <- faltantes2 %>% 
  mutate(PUNTARENAS = ifelse(str_detect(Desc, regex("río Grande de Térraba", ignore_case = TRUE)), 
                             TRUE, FALSE)) %>% 
  mutate_at(.vars = c("LIMON", "ALAJUELA", "HEREDIA", "CARTAGO", "SANJOSE", "PUNTARENAS", "GUANACASTE"), 
            funs(if_else(str_detect(Desc, 
                                    regex("huracán", ignore_case = TRUE)), TRUE, .))) %>% 
  mutate_at(.vars = c("LIMON", "ALAJUELA", "HEREDIA", "CARTAGO", "SANJOSE", "PUNTARENAS", "GUANACASTE"), 
            funs(if_else(str_detect(Desc, 
                                    regex("ciclón tropical", ignore_case = TRUE)), TRUE, .))) %>% 
  mutate_at(.vars = c("LIMON", "ALAJUELA", "HEREDIA", "CARTAGO", "SANJOSE", "PUNTARENAS", "GUANACASTE"), 
            funs(if_else(str_detect(Desc, 
                                    regex("huracanes", ignore_case = TRUE)), TRUE, .))) %>% 
  mutate_at(.vars = c("LIMON", "ALAJUELA", "HEREDIA", "CARTAGO", "SANJOSE", "PUNTARENAS", "GUANACASTE"), 
            funs(if_else(str_detect(Desc, 
                                    regex("tormenta tropical", ignore_case = TRUE)), TRUE, .))) %>% 
  mutate_at(.vars = c("LIMON", "ALAJUELA", "HEREDIA", "CARTAGO", "SANJOSE", "PUNTARENAS", "GUANACASTE"), 
            funs(if_else(str_detect(Desc, 
                                    regex("sistema\\s*\\w*\\sbaja presión", ignore_case = TRUE)), TRUE, .)))
  
```
Faltantes:
```{r}
faltantes3 <- faltantes2_mod %>% 
  mutate(total = GUANACASTE + SANJOSE + HEREDIA + ALAJUELA + PUNTARENAS + CARTAGO + LIMON) %>% 
  filter(total == 0)

faltantes3 %>% summarise(n())
```

Luego del proceso de tratar de asignar automáticamente una provincia a cada evento a través de un análisis de las descripciones, quedamos con 15 eventos que debemos revisar manualmente y asignarle una provincia.
Tomando como base la tabla *faltantes3* asignamos provincias de acuerdo a la columna *ID*.


```{r}
#ID asignado a cada provincia
CARTAGOm <- c(8, 49, 62, 98, 101, 103, 104, 105)
SANJOSEm <- c(50, 62, 98, 101, 103, 105)
HEREDIAm <- c(62, 98, 101, 103, 105)
GUANACASTEm <- c(62, 80, 98, 101, 103, 105)
PUNTARENASm <- c(56, 62, 80, 98, 101, 103, 105)
ALAJUELAm <- c(62, 98, 101, 103, 104, 105)
LIMONm <- c(21, 49, 62, 63, 67, 94, 98, 101, 103, 104, 105) 
```

Asignar valores **TRUE** a las filas correspondientes (número en cada vector) de las columnas de cada provincia.
```{r}
faltantes3_mod <- faltantes3 %>% 
  mutate(CARTAGO = if_else(ID %in% CARTAGOm, TRUE, FALSE),
         SANJOSE = if_else(ID %in% SANJOSEm, TRUE, FALSE),
         HEREDIA = if_else(ID %in% HEREDIAm, TRUE, FALSE),
         GUANACASTE = if_else(ID %in% GUANACASTEm, TRUE, FALSE),
         PUNTARENAS = if_else(ID %in% PUNTARENASm, TRUE, FALSE),
         ALAJUELA = if_else(ID %in% ALAJUELAm, TRUE, FALSE),
         LIMON = if_else(ID %in% LIMONm, TRUE, FALSE))
```

Juntar todas las tablas:
```{r}
tablaGLimpia <- rbind(faltantes3_mod, 
      faltantes2_mod %>% 
        mutate(total = GUANACASTE + SANJOSE + HEREDIA + ALAJUELA + PUNTARENAS + CARTAGO + LIMON) %>% 
        filter(total != 0), 
      faltantes_mod %>% 
        mutate(total = GUANACASTE + SANJOSE + HEREDIA + ALAJUELA + PUNTARENAS + CARTAGO + LIMON) %>% 
        filter(total != 0),
      tablaGeneral_mod %>% 
        mutate(total = GUANACASTE + SANJOSE + HEREDIA + ALAJUELA + PUNTARENAS + CARTAGO + LIMON) %>% 
        filter(total != 0)) %>% 
  select(-Desc, -total)
```

Gráfico de número de desastres por provincia:
```{r}
ggplot(tablaGLimpia %>% 
         select(5, 7:13) %>% 
         group_by(TIPO) %>% 
         summarise_all(funs(sum(.))) %>% 
         gather(key = PROVINCIA, value = TOTAL, -TIPO), 
       aes(x = PROVINCIA, y = TOTAL, fill = TIPO)) +
  geom_col()
```



Descargar datos geográficos de límites provinciales y toponimia.
```{r message=FALSE, warning=FALSE}
library(gdalUtils)
library(rgdal)
library(rmapshaper)

dsn_prov <- "WFS:http://geos.snitcr.go.cr/be/IGN_5/wfs?"
ogrListLayers(dsn_prov) #lista de capas en ese WFS

provincias_geo <- st_read(dsn_prov, "IGN_5:limiteprovincial_5k")
provincias_geo <- ms_simplify(ms_simplify(provincias_geo)) #simplificación de borde de los polígonos
  
dsn_pob <- "WFS:http://geos.snitcr.go.cr/be/IGN_NG/wms?"
ogrListLayers(dsn_pob) #lista de capas en ese WFS

poblados_geo <- st_read(dsn_pob, "IGN_NG:toponimos_25k")
```

##Mapa con total de incidentes por provincias:

Conteo de eventos por provincia
```{r}
numProvin <- provincias_geo %>% 
  select(nom_prov) %>% 
  left_join(tablaGLimpia %>% 
              select(5, 7:13) %>% 
              group_by(TIPO) %>% 
              summarise_all(funs(sum(.))) %>% 
              gather(key = PROVINCIA, value = TOTAL, -TIPO) %>% 
              mutate(PROVINCIA = replace(PROVINCIA, PROVINCIA == "SANJOSE", "San José"), 
                     PROVINCIA = replace(PROVINCIA, PROVINCIA == "GUANACASTE", "Guanacaste"),
                     PROVINCIA = replace(PROVINCIA, PROVINCIA == "LIMON", "Limón"),
                     PROVINCIA = replace(PROVINCIA, PROVINCIA == "HEREDIA", "Heredia"),
                     PROVINCIA = replace(PROVINCIA, PROVINCIA == "PUNTARENAS", "Puntarenas"),
                     PROVINCIA = replace(PROVINCIA, PROVINCIA == "CARTAGO", "Cartago"),
                     PROVINCIA = replace(PROVINCIA, PROVINCIA == "ALAJUELA", "Alajuela")),
            by = c("nom_prov" = "PROVINCIA"))
```

Mapa:
```{r}
library(tmap)

bbox <- st_bbox(c(xmin = 262775, xmax = 687268, ymax = 1247377, ymin = 868364))

tm_hidro <- tm_shape(numProvin %>% filter(TIPO == "Hidrometeorológicos"),
                     bbox = bbox) +
  tm_polygons(col = "TOTAL", palette = "Blues")

tm_deliz <- tm_shape(numProvin %>% filter(TIPO == "Deslizamientos"),
                     bbox = bbox) +
  tm_polygons(col = "TOTAL")

tmap_arrange(tm_hidro, tm_deliz)
```


Ahora podemos hacer una animación de los eventos cada decenio a partir de 1950
```{r}

```

