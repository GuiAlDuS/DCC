---
title: "Visualización de la base de datos de desastres en Costa Rica"
author: "Guillermo Durán Sanabria"
date: "11/29/2018"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

El objetivo de este tutorial es hacer un análisis temporal y geográfico de los desastres relacionados a eventos hidrometeorológicos y deslizamientos en Costa Rica. El análisis se llevará a cabo utilizando datos publicos generados por distintas instituciones gubernamentales de Costa Rica.  

***

### Procedencia de los datos
* Los datos se extrayeron del pdf de la 2nda edición del documento *Histórico de desastres en Costa Rica. Febrero 1723 - Abril 2017*[^1] elaborado por la [**Comisión nacional de prevención de riesgos y atención de emergencias (CNE) de Costa Rica**](https://www.cne.go.cr) utilizando la herramienta gratuita [Tabula](https://tabula.technology).

[^1]: El documento pdf puede descargarse del siguiente enlace:
https://www.cne.go.cr/index.php/documentacienuprincipal-96/historico-de-desastres-en-costa-rica

* Para el análisis se extrayeron del documento las tablas sobre los eventos hidrometeorológicos y deslizamientos. Se seleccionaron únicamente estos dos tipos de desastres por ser los que guardan una relación directa con el clima.

* Este tutorial se llevará a cabo utilizando R junto con los paquetes del **tidyverse** para la manipulación de los datos,**tidytext** para el análisis de texto, **lubridate** para las series de tiempo, y los paquetes **sf** y **tmap** para el análisis espacial y generación de mapas.
```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(lubridate)
library(sf)
library(tmap)
```

***
### Intrucciones para realizar el análisis

1. Preparación de la tabla general utilizando las tablas generadas en Tabula.

Notese que la columna de FECHA se está importando como tipo *date* y se están eliminando los encabezados de cada tabla individual.

```{r message=FALSE, warning=FALSE}
tablahidro <- read_csv("datos/tabula-historico_desastres_hidrometeo.csv", 
    col_types = cols(FECHA = col_date(format = "%Y/%m/%d"))) %>% 
  na.omit() %>% 
  mutate(TIPO = "Hidrometeorológicos")

tablades <- read_csv("datos/tabula-historico_desastres_deslizamientos.csv", 
    col_types = cols(FECHA = col_date(format = "%Y/%m/%d"))) %>% 
  na.omit() %>% 
  mutate(TIPO = "Deslizamientos")

names(tablahidro) <- names(tablades) #hacemos que los encabezados de ambas tablas sean iguales 
tablaGeneral <- rbind(tablades, tablahidro) %>%  #juntamos ambas tablas en una tabla general
  mutate(ID = row_number())
```

Gráfico cronológico con el número de eventos por cada tipo de desastre.
```{r}
ggplot(tablaGeneral %>% 
         mutate(aNo = year(FECHA)) %>% 
         group_by(aNo, TIPO) %>% 
         summarise(Cantidad = n()), 
       aes(x = aNo, y = Cantidad)) +
  geom_col() +
  facet_grid(rows = vars(TIPO)) +
  labs(x = "Año")
```

2. Utilizando las descripciones de cada evento, trataremos de asignar automáticamente las provincias que impactaron.

Dado que la tabla no tiene un componente geográfico en su estructura, vamos a asignarle uno. El código crea una columna lógica por provincia y le asigna un **TRUE** o **FALSE** si el nombre de la provincia aparece en la columna *`TÍTULO DEL EVENTO`*. Se hizo de esta manera ya que hay varios eventos que reportaron daños en varias provincias.

```{r}
tablaGeneral_mod <- tablaGeneral %>% 
  mutate(
    `TÍTULO DEL EVENTO` = str_replace_all(`TÍTULO DEL EVENTO`, "\\r", " "),
    OBSERVACIONES  = str_replace_all(`TÍTULO DEL EVENTO`, "\\r", " "),
    Desc = paste(`TÍTULO DEL EVENTO`, OBSERVACIONES, sep = " "),
    GUANACASTE = if_else(str_detect(Desc, "Guanacaste"), TRUE, FALSE),
    SANJOSE = if_else(str_detect(Desc, "San José"), TRUE, FALSE),
    HEREDIA = if_else(str_detect(Desc, "Heredia"), TRUE, FALSE),
    ALAJUELA = if_else(str_detect(Desc, "Alajuela"), TRUE, FALSE),
    PUNTARENAS = if_else(str_detect(Desc, "Puntarenas"), TRUE, FALSE),
    CARTAGO = if_else(str_detect(Desc, "Cartago"), TRUE, FALSE),
    LIMON = if_else(str_detect(Desc, "Limón"), TRUE, FALSE))
```

El conteo de eventos por provincia es:
```{r}
tablaGeneral_mod %>% select(8:14) %>% summarise_all(funs(sum(.)))
```

Revisión de elementos sin provincia asignada:
```{r}
faltantes <- tablaGeneral_mod %>% 
  mutate(total = GUANACASTE + SANJOSE + HEREDIA + ALAJUELA + PUNTARENAS + CARTAGO + LIMON) %>% 
  filter(total == 0)

faltantes %>% summarise(n())
```

Deberemos asignar provincia a los 49 eventos que quedaron sin asignar. 

Como el número de entradas que quedaron sin asignar no es tan grande, la asignación de las provincias podría hacerse manualmente en un programa de hoja de cálculo (Excel, por ejemplo), pero también lo podemos hacer automáticamente desde R.

Para esto último debemos primero hacer un conteo de las palabras más comunes en los títulos de esos 49 eventos utilizando los paquetes **tidytext** y un vector de *stop_words* en Castellano del paquete **tm**.

```{r}
library(tm)
library(tidytext)

custom_stop_words <- bind_rows(
  stop_words,
  data_frame(Palabras = tm::stopwords(kind = "sp"),
             lexicon = "custom")) %>% 
  filter(lexicon == "custom")
```

Conteo de palabras en las descripciones de los eventos:
```{r}
faltantes %>% select(ID, Desc) %>%
  unnest_tokens(Palabras, Desc) %>% 
  anti_join(custom_stop_words) %>%
  count(Palabras, sort = TRUE)
```

Viendo las palabras más comunes nos damos cuenta que hay frases que podemos asignar a las provincias, estas son:
- **Vertiente Caribe: Limón, Alajuela, Heredia, Cartago**
- **Vertiente Caribe = Zona Atlántica**
- **Zona Norte: Alajuela y Heredia**
- **Valle Central: Heredia, San José, Alajuela y Cartago**
- **Zona Sur: Puntarenas**

Escribimos un script que asocie esas palabras con las provincias respectivas:
```{r}
faltantes_mod <- faltantes %>% 
  mutate_at(.vars = c("LIMON", "ALAJUELA", "HEREDIA", "CARTAGO"), 
            funs(if_else(str_detect(Desc, regex("Vertiente Caribe", ignore_case = TRUE)), 
                         TRUE, .))) %>% 
  mutate_at(.vars = c("LIMON", "ALAJUELA", "HEREDIA", "CARTAGO"), 
            funs(if_else(str_detect(Desc, regex("Vertiente\\s*\\w*\\sCaribe", ignore_case = TRUE)), 
                         TRUE, .))) %>% 
  mutate_at(.vars = c("LIMON", "ALAJUELA", "HEREDIA", "CARTAGO"), 
            funs(if_else(str_detect(Desc, regex("Zona Caribe", ignore_case = TRUE)), 
                         TRUE, .))) %>% 
  mutate_at(.vars = c("LIMON", "ALAJUELA", "HEREDIA", "CARTAGO"), 
            funs(if_else(str_detect(Desc, regex("Zona Atlántica", ignore_case = TRUE)), 
                         TRUE, .))) %>% 
  mutate_at(.vars = c("ALAJUELA", "HEREDIA", "CARTAGO"), 
            funs(if_else(str_detect(Desc, regex("Zona Norte", ignore_case = TRUE)), 
                         TRUE, .))) %>% 
  mutate_at(.vars = c("PUNTARENAS"), 
            funs(if_else(str_detect(Desc, regex("Zona Sur", ignore_case = TRUE)), 
                         TRUE, .))) %>% 
  mutate_at(.vars = c("SANJOSE", "ALAJUELA", "HEREDIA", "CARTAGO"), 
            funs(if_else(str_detect(Desc, regex("Valle Central", ignore_case = TRUE)), 
                         TRUE, .)))
```

Aún luego del paso anterior nos quedan varios eventos sin provincia asignada:
```{r}
faltantes2 <- faltantes_mod %>% 
  mutate(total = GUANACASTE + SANJOSE + HEREDIA + ALAJUELA + PUNTARENAS + CARTAGO + LIMON) %>% 
  filter(total == 0)

faltantes2 %>% summarise(n())
```

```{r}
faltantes2
```

Revisando las descripciones de los que quedan por asignar vemos que muchos son huracanes, tormentas (tropicales) y sistemas de baja (presión):
```{r}
faltantes2 %>% select(ID, Desc) %>%
  unnest_tokens(Palabras, Desc) %>% 
  anti_join(custom_stop_words) %>%
  count(Palabras, sort = TRUE)
```

Ya que estos no tienen una ubicación asignada, asumimos que afectaron a todo el país:
```{r}
faltantes2_mod <- faltantes2 %>% 
  mutate(PUNTARENAS = ifelse(str_detect(Desc, regex("río Grande de Térraba", ignore_case = TRUE)), 
                             TRUE, FALSE)) %>% 
  mutate_at(.vars = c("LIMON", "ALAJUELA", "HEREDIA", "CARTAGO", "SANJOSE", "PUNTARENAS", "GUANACASTE"), 
            funs(if_else(str_detect(Desc, 
                                    regex("huracán", ignore_case = TRUE)), TRUE, .))) %>% 
  mutate_at(.vars = c("LIMON", "ALAJUELA", "HEREDIA", "CARTAGO", "SANJOSE", "PUNTARENAS", "GUANACASTE"), 
            funs(if_else(str_detect(Desc, 
                                    regex("ciclón tropical", ignore_case = TRUE)), TRUE, .))) %>% 
  mutate_at(.vars = c("LIMON", "ALAJUELA", "HEREDIA", "CARTAGO", "SANJOSE", "PUNTARENAS", "GUANACASTE"), 
            funs(if_else(str_detect(Desc, 
                                    regex("huracanes", ignore_case = TRUE)), TRUE, .))) %>% 
  mutate_at(.vars = c("LIMON", "ALAJUELA", "HEREDIA", "CARTAGO", "SANJOSE", "PUNTARENAS", "GUANACASTE"), 
            funs(if_else(str_detect(Desc, 
                                    regex("tormenta tropical", ignore_case = TRUE)), TRUE, .))) %>% 
  mutate_at(.vars = c("LIMON", "ALAJUELA", "HEREDIA", "CARTAGO", "SANJOSE", "PUNTARENAS", "GUANACASTE"), 
            funs(if_else(str_detect(Desc, 
                                    regex("sistema\\s*\\w*\\sbaja presión", ignore_case = TRUE)), TRUE, .)))
  
```

Las faltantes luego del paso anterior:
```{r}
faltantes3 <- faltantes2_mod %>% 
  mutate(total = GUANACASTE + SANJOSE + HEREDIA + ALAJUELA + PUNTARENAS + CARTAGO + LIMON) %>% 
  filter(total == 0)

faltantes3 %>% summarise(n())
```

Luego del proceso de tratar de asignar automáticamente una provincia a cada evento a través de un análisis de las descripciones, quedamos con 15 eventos que debemos revisar manualmente y asignarle una provincia.
Tomando como base la tabla *faltantes3* asignamos provincias de acuerdo a la columna *ID*.

```{r}
#ID asignado a cada provincia
CARTAGOm <- c(8, 49, 62, 98, 101, 103, 104, 105)
SANJOSEm <- c(50, 62, 98, 101, 103, 105)
HEREDIAm <- c(62, 98, 101, 103, 105)
GUANACASTEm <- c(62, 80, 98, 101, 103, 105)
PUNTARENASm <- c(56, 62, 80, 98, 101, 103, 105)
ALAJUELAm <- c(62, 98, 101, 103, 104, 105)
LIMONm <- c(21, 49, 62, 63, 67, 94, 98, 101, 103, 104, 105) 
```

Asignamos valores **TRUE** a las filas correspondientes (número en cada vector) de las columnas de cada provincia.
```{r}
faltantes3_mod <- faltantes3 %>% 
  mutate(CARTAGO = if_else(ID %in% CARTAGOm, TRUE, FALSE),
         SANJOSE = if_else(ID %in% SANJOSEm, TRUE, FALSE),
         HEREDIA = if_else(ID %in% HEREDIAm, TRUE, FALSE),
         GUANACASTE = if_else(ID %in% GUANACASTEm, TRUE, FALSE),
         PUNTARENAS = if_else(ID %in% PUNTARENASm, TRUE, FALSE),
         ALAJUELA = if_else(ID %in% ALAJUELAm, TRUE, FALSE),
         LIMON = if_else(ID %in% LIMONm, TRUE, FALSE))
```

Juntamos todas las tablas:
```{r}
tablaGLimpia <- rbind(faltantes3_mod, 
      faltantes2_mod %>% 
        mutate(total = GUANACASTE + SANJOSE + HEREDIA + ALAJUELA + PUNTARENAS + CARTAGO + LIMON) %>% 
        filter(total != 0), 
      faltantes_mod %>% 
        mutate(total = GUANACASTE + SANJOSE + HEREDIA + ALAJUELA + PUNTARENAS + CARTAGO + LIMON) %>% 
        filter(total != 0),
      tablaGeneral_mod %>% 
        mutate(total = GUANACASTE + SANJOSE + HEREDIA + ALAJUELA + PUNTARENAS + CARTAGO + LIMON) %>% 
        filter(total != 0)) %>% 
  select(-Desc, -total)
```

Finalmente podemos graficar el número de desastres totales por provincia:
```{r}
ggplot(tablaGLimpia %>% 
         select(5, 7:13) %>% 
         group_by(TIPO) %>% 
         summarise_all(funs(sum(.))) %>% 
         gather(key = PROVINCIA, value = TOTAL, -TIPO) %>% 
         mutate(PROVINCIA = replace(PROVINCIA, PROVINCIA == "SANJOSE", "San José"), 
                PROVINCIA = replace(PROVINCIA, PROVINCIA == "GUANACASTE", "Guanacaste"),
                PROVINCIA = replace(PROVINCIA, PROVINCIA == "LIMON", "Limón"),
                PROVINCIA = replace(PROVINCIA, PROVINCIA == "HEREDIA", "Heredia"),
                PROVINCIA = replace(PROVINCIA, PROVINCIA == "PUNTARENAS", "Puntarenas"),
                PROVINCIA = replace(PROVINCIA, PROVINCIA == "CARTAGO", "Cartago"),
                PROVINCIA = replace(PROVINCIA, PROVINCIA == "ALAJUELA", "Alajuela")), 
       aes(x = PROVINCIA, y = TOTAL, fill = TIPO)) +
  geom_col() +
  labs(x = "Provincia", y = "Número total de eventos", fill = "Tipo de evento")
```

3. Creación de mapas

Descargamos los datos geográficos de límites provinciales y toponimia del **Sistema Nacional de Información Territorial** (SNIT).
```{r message=FALSE, warning=FALSE}
library(gdalUtils)
library(rgdal)
library(rmapshaper)

dsn_prov <- "WFS:http://geos.snitcr.go.cr/be/IGN_5/wfs?"
ogrListLayers(dsn_prov) #lista de capas en ese WFS

provincias_geo <- st_read(dsn_prov, "IGN_5:limiteprovincial_5k")
provincias_geo <- ms_simplify(ms_simplify(provincias_geo)) #simplificación de borde de los polígonos
  
dsn_pob <- "WFS:http://geos.snitcr.go.cr/be/IGN_NG/wms?"
ogrListLayers(dsn_pob) #lista de capas en ese WFS

poblados_geo <- st_read(dsn_pob, "IGN_NG:toponimos_25k")
```

### Mapas con número de eventos por provincias:

Primero hacemos un conteo de eventos por provincia y hacemos una unión de tablas utilizando el límite provincial descargado en el paso anterior (notese que este último es un objeto **sf**)
```{r}
numProvin <- provincias_geo %>% 
  select(nom_prov) %>% 
  left_join(tablaGLimpia %>% 
              select(5, 7:13) %>% 
              group_by(TIPO) %>% 
              summarise_all(funs(sum(.))) %>% 
              gather(key = PROVINCIA, value = TOTAL, -TIPO) %>% 
              mutate(PROVINCIA = replace(PROVINCIA, PROVINCIA == "SANJOSE", "San José"), 
                     PROVINCIA = replace(PROVINCIA, PROVINCIA == "GUANACASTE", "Guanacaste"),
                     PROVINCIA = replace(PROVINCIA, PROVINCIA == "LIMON", "Limón"),
                     PROVINCIA = replace(PROVINCIA, PROVINCIA == "HEREDIA", "Heredia"),
                     PROVINCIA = replace(PROVINCIA, PROVINCIA == "PUNTARENAS", "Puntarenas"),
                     PROVINCIA = replace(PROVINCIA, PROVINCIA == "CARTAGO", "Cartago"),
                     PROVINCIA = replace(PROVINCIA, PROVINCIA == "ALAJUELA", "Alajuela")),
            by = c("nom_prov" = "PROVINCIA"))
```

Generación de los mapas:
```{r}
library(tmap)

bbox <- st_bbox(c(xmin = 270000, xmax = 680000, ymax = 1260000, ymin = 880000))

tm_hidro <- tm_shape(numProvin %>% filter(TIPO == "Hidrometeorológicos"),
                     bbox = bbox) +
  tm_polygons(col = "TOTAL", palette = "Blues") +
  tm_layout(title = "Eventos hidrometeorológicos",
            legend.format = list(text.separator = "-"))

tm_deliz <- tm_shape(numProvin %>% filter(TIPO == "Deslizamientos"),
                     bbox = bbox) +
  tm_polygons(col = "TOTAL") +
  tm_layout(title = "Deslizamientos",
            legend.format = list(text.separator = "-"))

tmap_arrange(tm_hidro, tm_deliz)
```

Calculo de cantidad de eventos por década a partir de 1950:
```{r}
numProvinDecada <- provincias_geo %>% 
  select(nom_prov) %>% 
  left_join(tablaGLimpia %>% 
              filter(FECHA >= ymd("1950-01-01")) %>% 
              mutate(DECADA = format(floor_date(FECHA, years(10)), '%Y')) %>% 
              select(5, 7:14) %>% 
              group_by(TIPO, DECADA) %>% 
              summarise_all(funs(sum(.))) %>% 
              gather(key = PROVINCIA, value = TOTAL, -TIPO, -DECADA) %>% 
              mutate(PROVINCIA = replace(PROVINCIA, PROVINCIA == "SANJOSE", "San José"), 
                     PROVINCIA = replace(PROVINCIA, PROVINCIA == "GUANACASTE", "Guanacaste"),
                     PROVINCIA = replace(PROVINCIA, PROVINCIA == "LIMON", "Limón"),
                     PROVINCIA = replace(PROVINCIA, PROVINCIA == "HEREDIA", "Heredia"),
                     PROVINCIA = replace(PROVINCIA, PROVINCIA == "PUNTARENAS", "Puntarenas"),
                     PROVINCIA = replace(PROVINCIA, PROVINCIA == "CARTAGO", "Cartago"),
                     PROVINCIA = replace(PROVINCIA, PROVINCIA == "ALAJUELA", "Alajuela")),
            by = c("nom_prov" = "PROVINCIA"))
```

Gráficos por décadas:
```{r}
ggplot(numProvinDecada, aes(x = nom_prov, y = TOTAL, fill = TIPO)) +
  geom_col() +
  facet_grid(rows = vars(DECADA)) +
  labs(x = "Provincias", 
       y = "Total de eventos", 
       title = "Número de eventos por década",
       fill = "Tipo de evento")
```

### Mapas por década:
Preparación de los datos

Para tener una escala estándar de colores para cada década calculamos los máximos y mínimos acumulados:
```{r}
summary(numProvinDecada %>% as.data.frame() %>% 
  group_by(DECADA, TIPO, nom_prov) %>% 
  summarise(TOTAL = sum(TOTAL)) %>% 
  spread(key = TIPO, value = TOTAL))
```

Función de mapeo
```{r}
decadas <- numProvinDecada %>% 
  as.data.frame() %>% 
  select(DECADA) %>% 
  arrange(DECADA) %>% 
  group_by(DECADA) %>% 
  summarise() %>% 
  pull(DECADA)



funMapasDec <- function(dec) {
  tm_hidro <- tm_shape(numProvinDecada %>% 
                         filter(TIPO == "Hidrometeorológicos" &
                                  DECADA == dec),
                       bbox = bbox) +
    tm_polygons(col = "TOTAL", 
                palette = "Blues",
                style = "fixed",
                breaks = c(1, 3, 6, 9, 12, 15),
                colorNA = "white") +
    tm_layout(main.title = "Eventos hidrometeorológicos",
              title = paste0("Década de ", dec),
              legend.format=list(fun=function(x) formatC(x, digits=0, format="d"), text.separator = "-"))
  
  if (is.element("Deslizamientos", numProvinDecada %>% 
                 filter(DECADA == dec) %>% 
                 pull(TIPO))) {
    tm_deliz <- tm_shape(numProvinDecada %>% 
                           filter(TIPO == "Deslizamientos" &
                                    DECADA == dec),
                         bbox = bbox) +
      tm_polygons(col = "TOTAL",
                  palette = "YlOrBr",
                  style = "fixed",
                  breaks = c(0, 1, 2, 3, 4)) +
      tm_layout(main.title = "Deslizamientos")
    
    tmap_arrange(tm_hidro, tm_deliz)
  } else {
    tmap_arrange(tm_hidro)
  }
} 

```

Creación de los mapas:
```{r}
map(decadas, funMapasDec)
```

Y finalmente, el código de un app en Shiny que funcione para seleccionar el periodo de tiempo y nos muestrre un mapa de los eventos y la tabla con la descripción de los mismos.

***



